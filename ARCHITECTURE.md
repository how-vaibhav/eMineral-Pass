# Form â†’ QR â†’ PDF â†’ Dashboard System Architecture

## ğŸ“ System Overview

This is a production-ready SaaS application designed for repeatable form workflows. A single authenticated host (admin/operator) repeatedly submits structured forms, each generating a unique public page, QR code, and printable PDF. End users scan QRs to view public pagesâ€”no authentication required.

### Core Workflow
```
Host (Authenticated) â†’ Fill Form â†’ Submit â†’ Generate Record
                                                  â”œâ”€ Unique ID (UUID)
                                                  â”œâ”€ Public URL
                                                  â”œâ”€ QR Code
                                                  â””â”€ PDF (A4, print-ready)
                                                       â†“
                                           Dashboard Track & Analytics
                                                       â†“
End User (QR Scan) â†’ View Public Page (Read-only, no auth)
                           â”œâ”€ Form data display
                           â”œâ”€ Status badge (Active/Expired)
                           â”œâ”€ PDF download
                           â””â”€ Scan logged to DB
```

---

## ğŸ—ï¸ Architecture Layers

### Frontend (Next.js App Router + React)
- **Type-safe**: Full TypeScript
- **Styling**: Tailwind CSS with dark/light mode support
- **Animations**: Framer Motion for micro-interactions
- **Theme**: next-themes for persistent dark/light toggle
- **Components**: Reusable, compound component pattern

### Backend (Next.js Server Actions + API Routes)
- **Auth**: Supabase JWT-based authentication
- **Database**: PostgreSQL via Supabase
- **Storage**: Supabase Storage for PDF artifacts
- **Validation**: Zod schemas (client + server)

### Infrastructure
- **Deployment**: Vercel (auto-deploy from git)
- **Database**: Supabase (managed PostgreSQL)
- **Real-time**: Supabase Real-time subscriptions (optional, for live dashboard)

---

## ğŸ“¦ Folder Structure

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ signup/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ (dashboard)/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx                   # Main dashboard
â”‚   â”‚   â”œâ”€â”€ records/
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx           # Record detail view
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ analytics/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ (public)/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ records/
â”‚   â”‚   â”‚   â””â”€â”€ [recordId]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx           # Public page (QR scanner view)
â”‚   â”‚   â””â”€â”€ error.tsx
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ logout/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts
â”‚   â”‚   â”‚   â””â”€â”€ refresh/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”‚   â”œâ”€â”€ records/
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts               # GET/POST records
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â”œâ”€â”€ route.ts           # GET/DELETE single record
â”‚   â”‚   â”‚       â”œâ”€â”€ pdf/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ route.ts       # Generate/download PDF
â”‚   â”‚   â”‚       â””â”€â”€ qr/
â”‚   â”‚   â”‚           â””â”€â”€ route.ts       # Generate QR code
â”‚   â”‚   â”œâ”€â”€ scan-log/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts               # Log QR scan events
â”‚   â”‚   â””â”€â”€ analytics/
â”‚   â”‚       â””â”€â”€ route.ts               # Aggregated stats
â”‚   â””â”€â”€ layout.tsx                     # Root layout (theme provider)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”œâ”€â”€ FormField.tsx
â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â”œâ”€â”€ Badge.tsx
â”‚   â”‚   â””â”€â”€ Skeleton.tsx
â”‚   â”œâ”€â”€ form/
â”‚   â”‚   â”œâ”€â”€ FormBuilder.tsx            # Dynamic form renderer
â”‚   â”‚   â”œâ”€â”€ FormStep.tsx               # Individual form step
â”‚   â”‚   â”œâ”€â”€ FormValidator.tsx          # Client-side validation
â”‚   â”‚   â””â”€â”€ AutoGeneratedFields.tsx    # Read-only timestamp fields
â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”œâ”€â”€ Navbar.tsx
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â”œâ”€â”€ ThemeToggle.tsx
â”‚   â”‚   â””â”€â”€ Footer.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ RecordsTable.tsx
â”‚   â”‚   â”œâ”€â”€ StatsCard.tsx
â”‚   â”‚   â”œâ”€â”€ FilterBar.tsx
â”‚   â”‚   â””â”€â”€ AnalyticsChart.tsx
â”‚   â”œâ”€â”€ qr/
â”‚   â”‚   â”œâ”€â”€ QRDisplay.tsx
â”‚   â”‚   â””â”€â”€ QRScanner.tsx              # (Optional mobile scanner)
â”‚   â””â”€â”€ pdf/
â”‚       â””â”€â”€ PDFPreview.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase.ts                    # Supabase client config
â”‚   â”œâ”€â”€ auth.ts                        # Auth utilities
â”‚   â”œâ”€â”€ database.ts                    # Query builders & types
â”‚   â”œâ”€â”€ validation.ts                  # Zod schemas
â”‚   â”œâ”€â”€ pdf-generator.ts               # PDF generation logic
â”‚   â”œâ”€â”€ qr-generator.ts                # QR code logic
â”‚   â”œâ”€â”€ storage.ts                     # File storage operations
â”‚   â”œâ”€â”€ api.ts                         # API client helpers
â”‚   â””â”€â”€ utils.ts                       # General utilities
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ database.ts                    # Database-generated types (optional)
â”‚   â”œâ”€â”€ forms.ts                       # Form types
â”‚   â”œâ”€â”€ records.ts                     # Record types
â”‚   â””â”€â”€ api.ts                         # API response types
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAuth.ts                     # Auth context hook
â”‚   â”œâ”€â”€ useRecords.ts                  # Records fetching & caching
â”‚   â”œâ”€â”€ useForm.ts                     # Form state management
â”‚   â”œâ”€â”€ useTheme.ts                    # Theme management
â”‚   â””â”€â”€ useScanLog.ts                  # Scan event logging
â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ AuthContext.tsx                # Auth state provider
â”‚   â””â”€â”€ ThemeContext.tsx               # Theme state provider
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ globals.css                    # Global styles + theme vars
â”‚   â”œâ”€â”€ animations.css                 # Micro-animation definitions
â”‚   â””â”€â”€ tailwind.config.ts             # Tailwind config
â””â”€â”€ scripts/
    â””â”€â”€ seed-db.ts                     # Database seeding (optional)
```

---

## ğŸ—„ï¸ Database Schema (PostgreSQL)

### Tables

#### 1. **users**
```sql
CREATE TABLE public.users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  full_name TEXT,
  is_admin BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  last_login TIMESTAMP WITH TIME ZONE,
  auth_provider TEXT DEFAULT 'email',
  auth_provider_id TEXT,
  is_active BOOLEAN DEFAULT true
);
CREATE INDEX idx_users_email ON users(email);
```

#### 2. **records** (Main data table)
```sql
CREATE TABLE public.records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  
  -- Form data (JSON for flexibility)
  form_data JSONB NOT NULL,
  
  -- Auto-generated fields (NOT user-editable)
  generated_on TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  valid_upto TIMESTAMP WITH TIME ZONE NOT NULL,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'expired', 'archived')),
  
  -- Unique identifiers
  public_token TEXT UNIQUE NOT NULL,  -- Used in public URL
  qr_code_url TEXT,                   -- Stored URL to QR image
  pdf_url TEXT,                       -- Stored URL to PDF file
  
  -- Metadata
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  archived_at TIMESTAMP WITH TIME ZONE,
  
  -- Denormalized for faster queries
  total_scans INTEGER DEFAULT 0,
  last_scan_at TIMESTAMP WITH TIME ZONE
);
CREATE INDEX idx_records_user_id ON records(user_id);
CREATE INDEX idx_records_public_token ON records(public_token);
CREATE INDEX idx_records_created_at ON records(created_at DESC);
CREATE INDEX idx_records_valid_upto ON records(valid_upto);
CREATE INDEX idx_records_status ON records(status);
```

#### 3. **scan_logs** (Track QR scans)
```sql
CREATE TABLE public.scan_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  record_id UUID NOT NULL REFERENCES public.records(id) ON DELETE CASCADE,
  
  -- Scan metadata
  scanned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  user_agent TEXT,
  ip_address TEXT,
  geolocation JSONB,  -- {latitude, longitude} (optional)
  referrer TEXT,
  
  -- Session tracking (optional)
  session_id TEXT
);
CREATE INDEX idx_scan_logs_record_id ON scan_logs(record_id);
CREATE INDEX idx_scan_logs_scanned_at ON scan_logs(scanned_at DESC);
CREATE INDEX idx_scan_logs_session_id ON scan_logs(session_id);
```

#### 4. **form_templates** (Store reusable form schemas)
```sql
CREATE TABLE public.form_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  
  name TEXT NOT NULL,
  description TEXT,
  schema JSONB NOT NULL,  -- Form field definitions
  
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_form_templates_user_id ON form_templates(user_id);
```

#### 5. **audit_logs** (Security & compliance)
```sql
CREATE TABLE public.audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
  
  action TEXT NOT NULL,  -- 'create_record', 'download_pdf', 'view_record', etc.
  entity_type TEXT NOT NULL,  -- 'record', 'user', 'form'
  entity_id UUID,
  
  old_values JSONB,
  new_values JSONB,
  
  ip_address TEXT,
  user_agent TEXT,
  
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

---

## ğŸ” Authentication Flow

### Supabase Auth (JWT-based)

1. **Login/Signup**
   - User submits credentials
   - Supabase Auth verifies & issues JWT token
   - Token stored in httpOnly cookie (secure)
   - Refresh token stored separately

2. **Protected Routes**
   - Middleware checks JWT in cookies
   - Verifies against Supabase session
   - If expired, attempts refresh
   - If refresh fails, redirect to login

3. **Server Actions**
   - Automatically receive auth context
   - Can directly access Supabase client with user session
   - No manual token passing needed

---

## ğŸ“‹ Form System

### Form Schema (Stored in DB or Config)
```typescript
interface FormFieldDefinition {
  id: string;
  name: string;
  label: string;
  type: 'text' | 'number' | 'date' | 'select' | 'textarea' | 'email' | 'phone';
  placeholder?: string;
  required: boolean;
  validation?: {
    minLength?: number;
    maxLength?: number;
    pattern?: string;
    min?: number;
    max?: number;
  };
  options?: Array<{ label: string; value: string }>;  // For select fields
}

interface FormSchema {
  id: string;
  title: string;
  description?: string;
  fields: FormFieldDefinition[];
  validityHours: number;  // How long record is valid
}
```

### Auto-Generated Fields (Read-only)
- **Generated On**: Server timestamp (not editable)
- **Valid Upto**: Auto-calculated based on `validityHours` (not editable)
- **Unique ID**: UUID (not editable)

---

## ğŸ¯ QR Code Logic

### Generation
```typescript
// 1. Generate on form submit (server action)
// 2. Encode: public page URL
// 3. Store QR code URL in Supabase Storage
// 4. Reference URL in record

// QR URL format:
https://yourdomain.com/records/{publicToken}
```

### Scanning
```typescript
// 1. User scans QR code
// 2. Browser opens public URL
// 3. Page loads with no auth required
// 4. Scan event logged to database (with metadata)
// 5. Display read-only data + optional PDF download
```

---

## ğŸ“„ PDF Generation

### Strategy
- **Library**: `@react-pdf/renderer` + `pdfkit` (server-side)
- **Format**: A4 (210mm Ã— 297mm)
- **Content**:
  - Professional header (logo, title)
  - Form data in table layout
  - QR code (embedded)
  - Footer (generated date, page numbers)
  - Deterministic: Same data = same PDF

### Flow
```typescript
// 1. User submits form
// 2. Server action creates record in DB
// 3. Server generates PDF immediately (async)
// 4. PDF stored in Supabase Storage
// 5. PDF URL saved in record
// 6. Return download link to client
```

### Storage
- Supabase Storage bucket: `pdfs/`
- Path: `pdfs/{userId}/{recordId}/{generatedOn}.pdf`
- Signed URLs for time-limited access

---

## ğŸ“Š Admin Dashboard

### Key Metrics
- **Total records created** (all time)
- **Total QR scans** (all time)
- **Records created today**
- **Records created this week**
- **Average scans per record**

### Records Table Features
- Sortable by: Date, Valid Upto, Scan count
- Filterable by: Date range, Status (Active/Expired), User
- Actions: View, Download PDF, Download QR, Delete
- Bulk actions: Export as CSV, Bulk delete

### Analytics
- Line chart: Records created per day (last 30 days)
- Line chart: Scans per day (last 30 days)
- Pie chart: Status distribution (Active/Expired/Archived)

---

## ğŸ¨ UI/UX Design System

### Theme System
- **Light Mode**: Clean, minimal (white background, dark text)
- **Dark Mode**: Eye-friendly (dark background, light text)
- **System Preference**: Auto-detect on first visit
- **Manual Toggle**: Easy switch in navbar

### Color Palette (Tailwind)
```css
Primary: blue-600 / blue-500
Secondary: slate-600 / slate-400
Success: green-600 / green-500
Warning: amber-600 / amber-500
Error: red-600 / red-500
```

### Animations
- **Page transitions**: Fade in (200ms)
- **Button hover**: Scale + shadow (150ms)
- **Form field focus**: Border color + glow (200ms)
- **Modal appear**: Fade + scale (300ms)
- **Loading skeleton**: Pulse (1.5s)
- **Success toast**: Slide in + auto-dismiss (3s)

### Responsive Breakpoints
- Mobile: < 640px (full-width, stacked)
- Tablet: 640px - 1024px (2-column, compact)
- Desktop: > 1024px (multi-column, full features)

---

## ğŸ”’ Security Considerations

### Public Pages
- **No authentication required**
- **Read-only data display**
- **No access to other records** (only via valid public token)
- **Scan logging**: Anonymized (no personal data)

### Admin Routes
- **JWT authentication required**
- **Admin-only actions**: Delete, Archive, Export
- **RBAC**: (Single admin for now, but extensible)
- **Audit logging**: All sensitive actions logged

### Validation
- **Client-side**: UX feedback (Zod)
- **Server-side**: Security validation (always re-validate)
- **Database**: NOT NULL constraints, type checking

### Rate Limiting
- **Form submissions**: 100/hour per user (prevent abuse)
- **Scan events**: 1000/hour per IP (prevent bot spam)
- **API endpoints**: 1000/hour per authenticated user

---

## ğŸš€ API Endpoints

### Auth
- `POST /api/auth/login`
- `POST /api/auth/signup`
- `POST /api/auth/logout`
- `POST /api/auth/refresh`

### Records
- `GET /api/records` - List records (auth required)
- `POST /api/records` - Create record (auth required)
- `GET /api/records/[id]` - Get single record (auth required)
- `DELETE /api/records/[id]` - Delete record (auth required)
- `GET /api/records/[id]/pdf` - Download PDF (auth required)
- `GET /api/records/[id]/qr` - Get QR image (auth required)

### Public
- `GET /api/public/records/[publicToken]` - Get public record data (NO auth)
- `POST /api/scan-log` - Log QR scan (NO auth)

### Analytics
- `GET /api/analytics/summary` - Dashboard stats (auth required)
- `GET /api/analytics/records` - Records per day (auth required)
- `GET /api/analytics/scans` - Scans per day (auth required)

---

## ğŸ“¦ Deployment (Vercel + Supabase)

### Environment Variables
```
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxxxx
SUPABASE_SERVICE_ROLE_KEY=xxxxx
NEXT_PUBLIC_APP_URL=https://yourdomain.com
```

### Database Migrations
- Use Supabase Migration CLI
- Store migrations in `supabase/migrations/` folder
- Deploy via Vercel integration

### Vercel Deployment
1. Connect GitHub repo to Vercel
2. Set environment variables in Vercel Dashboard
3. Enable auto-deploy on push to main
4. Configure cron jobs for PDF cleanup (optional)

---

## ğŸ”„ Repeatable Workflow Implementation

### User Journey
```
Host Opens App
  â†“
[Authentication Check]
  â†“
Redirect to Dashboard (if authenticated) or Login (if not)
  â†“
Host Clicks "New Record"
  â†“
[Form Modal/Page Opens]
  â†“
Host Fills Form Fields
  â†“
[Client-side validation]
  â†“
Host Clicks "Submit"
  â†“
[Server-side validation]
  â†“
Record Created + PDF Generated + QR Generated
  â†“
Success Toast: "Record created! PDF ready."
  â†“
[Form Auto-Reset]
  â†“
Host Can Immediately Fill Next Form (or close)
```

### Implementation Details
- Form component has `onSuccess` callback that resets state
- After submission, form fields cleared automatically
- User sees confirmation modal with download links
- Option to immediately create next record or return to dashboard
- No page reload required (smooth UX)

---

## ğŸ“ Future Scaling Considerations

- [ ] Multi-tenant support (multiple hosts/organizations)
- [ ] Role-based access control (RBAC) for team members
- [ ] Webhook integrations (Slack, email notifications)
- [ ] Custom domain branding for public pages
- [ ] API keys for third-party integrations
- [ ] Advanced analytics & export (CSV, Parquet)
- [ ] Mobile app (React Native)
- [ ] Offline support (Service Workers)

---

## ğŸ§ª Testing Strategy

- **Unit Tests**: Jest for utility functions
- **Integration Tests**: API routes with test database
- **E2E Tests**: Playwright for critical workflows
- **Performance**: Lighthouse CI

---

## ğŸ“ Support & Documentation

- **README.md**: Quick start, environment setup
- **API Documentation**: Auto-generated with Swagger (optional)
- **Code Comments**: TODO markers for future features
- **GitHub Issues**: Bug tracking & feature requests
